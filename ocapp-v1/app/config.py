from datetime import datetime
try:
    from zoneinfo import ZoneInfo
    IST = ZoneInfo("Asia/Kolkata")
except Exception:
    IST = None

INDEX_SYMBOLS = {
    "NIFTY", "BANKNIFTY", "NIFTY 50", "NIFTY BANK", "NIFTY-I", "BANKNIFTY-I"
}

# F&O stock universe (deduped, uppercased, sorted)
FNO_STOCKS = sorted({
    "360ONE","ABB","ABCAPITAL","ADANIENT","ADANIGREEN","ADANIPORTS","ALKEM","AMBER","AMJUBAJIEMC","ANGELONE","APOLLOHOSP",
    "APOLLOTYRE","ASHOKLEY","ASIANPAINT","ASTRAL","AUBANK","AUROPHARMA","AXISBANK","BAJAJ-AUTO","BAJAJFINSV","BAJFINANCE",
    "BANDHANBNK","BANKBARODA","BANKINDIA","BATAINDIA","BEL","BERGEPAINT","BHARATFORG","BHARTIARTL","BHEL","BIOCON","BOSCHLTD",
    "BPCL","BRITANNIA","BSOFT","CANBK","CAMS","CGPOWER","CHOLAFIN","CIPLA","COALINDIA","COFORGE","COLPAL","CONCOR","CROMPTON",
    "CUB","CUMMINSIND","CYIENT","DABUR","DALBHARAT","DEEPAKNTR","DELHIVERY","DIVISLAB","DIXON","DLF","DMART","DRREDDY","EICHERMOT",
    "ESCORTS","EXIDEIND","FEDERALBNK","GAIL","GLENMARK","GMRINFRA","GODREJCP","GODREJPROP","GRASIM","HAL","HAVELLS","HCLTECH",
    "HDFCAMC","HDFCBANK","HDFCLIFE","HEROMOTOCO","HFCL","HINDALCO","HINDCOPPER","HINDPETRO","HINDUNILVR","ICICIBANK","ICICIGI",
    "ICICIPRULI","IDEA","IDFC","IDFCFIRSTB","IEX","IGL","IIFL","INDHOTEL","INDIACEM","INDIGO","INDUSINDBK","INFY","INGERRAND",
    "IOC","IRCTC","IRFC","IRB","ITC","JINDALSTEL","JIOFIN","JSWENERGY","JSWSTEEL","JUBLFOOD","KALYANKJIL","KANSAINER",
    "KOTAKBANK","KPITTECH","LALPATHLAB","LICHSGFIN","LT","LTIM","LODHA","LUPIN","M&M","M&MFIN","MANAPPURAM","MARICO","MARUTI",
    "MAXHEALTH","MCDOWELL-N","MCX","MPHASIS","MOTHERSON","MUTHOOTFIN","NATIONALUM","NAVINFLUOR","NBCC","NESTLEIND","NHPC","NMDC",
    "NTPC","OBEROIRLTY","OFSS","OIL","ONGC","PAGEIND","PATANJALI","PAYTM","PERSISTENT","PETRONET","PFC","PFIZER","PIDILITIND",
    "PIIND","PNB","PNBHOUSING","POLICYBZR","POWERGRID","PVRINOX","RECLTD","RELAXO","RELIANCE","SAIL","SARFAMANCAP","SBICARD",
    "SBILIFE","SBIN","SHREECEM","SIEMENS","SOLARINDS","SONACOMS","SRF","SUNPHARMA","SUNTV","SUZLON","SYMPHONY","TATACHEM",
    "TATACOMM","TATACONSUM","TATAMOTORS","TATAPOWER","TATASTEEL","TCIEXP","TECHM","TITAN","TORNTPHARM","TRENT","TVSMOTOR",
    "UBL","ULTRACEMCO","UNIONBANK","UNITDSPR","UPL","VEDL","VOLTAS","WIPRO","YESBANK","ZEEL","ZYDUSLIFE"
})

# Live-fallback expiries
NIFTY_EXPIRIES_FALLBACK = [# ,"30SEP25","28OCT25","25NOV25","30DEC25","31MAR26","30JUN26","29DEC26","29JUN27","28DEC27","27JUN28","26DEC28"
    "23SEP25"
]
BANKNIFTY_EXPIRIES_FALLBACK = [  #,"28OCT25","25NOV25","30DEC25","31MAR26"
    "30SEP25"
]

# Historical expiries (from your list)
NIFTY_HISTORICAL_EXPIRIES = [
    '25FEB25', '18AUG25', '21AUG25', '14AUG25', '07AUG25', '31JUL25', '24JUL25',
    '17JUL25', '10JUL25', '03JUL25', '26JUN25', '19JUN25', '12JUN25', '05JUN25',
    '29MAY25', '22MAY25', '15MAY25', '08MAY25', '01MAY25', '24APR25', '17APR25',
    '10APR25', '03APR25', '27MAR25', '20MAR25', '13MAR25', '06MAR25', '27FEB25',
    '20FEB25', '13FEB25', '06FEB25', '30JAN25', '23JAN25', '16JAN25', '09JAN25',
    '02JAN25', '26DEC24', '19DEC24', '12DEC24', '05DEC24', '28NOV24', '21NOV24',
    '14NOV24', '07NOV24', '31OCT24', '24OCT24', '17OCT24', '10OCT24', '03OCT24',
    '26SEP24', '19SEP24', '12SEP24', '05SEP24', '29AUG24', '22AUG24', '15AUG24',
    '08AUG24', '01AUG24', '25JUL24', '18JUL24', '11JUL24', '04JUL24', '27JUN24',
    '20JUN24', '13JUN24', '06JUN24', '30MAY24', '23MAY24', '16MAY24', '09MAY24',
    '02MAY24', '25APR24', '18APR24', "16SEP25"
]
BANKNIFTY_HISTORICAL_EXPIRIES = [
    '28AUG25', '31JUL25', '26JUN25', '25JUN25', '29MAY25', '24APR25', '27MAR25',
    '27FEB25', '30JAN25', '23JAN25', '24OCT24', '17OCT24', '10OCT24', '03OCT24',
    '26SEP24', '19SEP24', '12SEP24', '05SEP24', '29AUG24', '22AUG24', '15AUG24',
    '08AUG24', '01AUG24', '25JUL24', '18JUL24', '11JUL24', '04JUL24', '27JUN24',
    '20JUN24', '13JUN24', '06JUN24', '30MAY24', '23MAY24', '16MAY24', '09MAY24',
    '02MAY24', '25APR24', '18APR24', '11APR24', '04APR24', '28MAR24', '21MAR24',
    '14MAR24', '07MAR24', '29FEB24', '21FEB24', '14FEB24', '07FEB24', '31JAN24',
    '25JAN24', '18JAN24', '11JAN24', '03JAN24', '28DEC23', '20DEC23', '13DEC23',
    '06DEC23', '30NOV23', '22NOV23', '15NOV23', '08NOV23', '01NOV23', '26OCT23',
    '18OCT23', '12OCT23', '04OCT23', '28SEP23', '21SEP23', '15SEP23', '08SEP23',
    '31AUG23', '24AUG23'
]

# numeric fields used when coercing values
NUM_FIELDS = {"ltp","oi","oi_change","iv","delta","gamma","theta","vega","volume"}

def now_ist():
    from datetime import datetime
    return datetime.now(IST) if IST else datetime.now()
